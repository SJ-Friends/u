<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <title>ë¡œë”© ì¤‘â€¦</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <style>
    th:nth-child(3), td:nth-child(3) { min-width: 120px; }
    th:nth-child(4), td:nth-child(4) { min-width: 80px; }
    th:nth-child(5), td:nth-child(5) { min-width: 80px; }
    th:nth-child(8), td:nth-child(8) { min-width: 120px; }
    th:nth-child(9), td:nth-child(9) { min-width: 90px; }
    th:nth-child(10), td:nth-child(10) { min-width: 70px; }

    body { font-family: 'Segoe UI', sans-serif; padding: 30px; max-width: 1000px; margin: auto; }
    .header { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px; }
    .header img { height: 40px; }
    .header h1 { margin: 0; font-size: 1.6em; }
    .top-bar { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 10px; }
    .button-group { display: flex; gap: 10px; align-items: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; font-size: 14px; }
    th { background-color: #f4f4f4; }
    button { padding: 6px 12px; cursor: pointer; border: none; border-radius: 4px; background-color: #1d72b8; color: white; }
    button:hover { background-color: #135a96; }
    select, input[type="checkbox"] { padding: 6px; }
    label { margin-right: 8px; }
    .tooltip { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }
    .link-button { color: #0077cc; text-decoration: underline; cursor: pointer; }
  </style>
</head>
<body>
  <div class="header">
    <img id="logoImg" alt="ë¡œê³ " src="logo.jpg"/>
    <h1 id="pageTitle">ì¼ìƒì„ ì—¬í–‰ì²˜ëŸ¼ ì¼ì • ëª©ë¡</h1>
  </div>

  <div class="top-bar">
    <div>
      <label for="sort">ì •ë ¬ ê¸°ì¤€:</label>
      <select id="sort">
        <option value="date_s">ì‹œì‘ ë‚ ì§œ</option>
        <option selected value="date_e">ì¢…ë£Œ ë‚ ì§œ</option>
        <option value="created_at">ì…ë ¥ ë‚ ì§œ</option>
      </select>
    </div>
    <div class="button-group">
      <label><input id="showDone" type="checkbox" checked/> ì™„ë£Œ í¬í•¨</label>
      <label><input id="showReserved" type="checkbox"/> ì˜ˆì•½ì™„ë£Œ í¬í•¨</label>
      <button id="btnAdd">â• ë“±ë¡í•˜ê¸°</button>
      <button id="btnCal">ğŸ“… ë‹¬ë ¥ ë³´ê¸°</button>
      <button id="btnRes">ğŸ“… ì˜ˆì•½ìº˜ë¦°ë”</button>
    </div>
  </div>

  <table id="schedule-table">
    <thead>
      <tr>
        <th>ì™„ë£Œ</th>
        <th>ì˜ˆì•½</th>
        <th>ì—…ì²´ëª…</th>
        <th>ë¹„ìš©</th>
        <th>ìœ„ì¹˜</th>
        <th>ì‹œì‘ì¼</th>
        <th>ì¢…ë£Œì¼</th>
        <th>ë¶ˆê°€ëŠ¥ ìš”ì¼</th>
        <th>ì²´í—˜ë‹¨</th>
        <th>AI</th>
        <th>ì‚­ì œ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    // Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„±
    const sb = window.sb.createClient(
      'https://xxmtxuhcdzidhrefrvwf.sb.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4bXR4dWhjZHppZGhyZWZydndmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQwODAyNTQsImV4cCI6MjA1OTY1NjI1NH0.TaCCDlJvKrif_pZY038Qkglip8h-Qqjp2w2GlKwvoVg'
    );

    // usr íŒŒë¼ë¯¸í„° ë° ì‚¬ìš©ì ì„¤ì • ë¡œë“œ
    const urlParams = new URLSearchParams(window.location.search);
    const usrParam = urlParams.get('usr');
    if (!usrParam) {
      alert('ìœ íš¨í•œ ì‚¬ìš©ì íŒŒë¼ë¯¸í„°(usr)ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
      throw new Error('Missing usr parameter');
    }
    let config;
    async function loadUserConfig() {
      const { data, error } = await supabase
        .from('usr')
        .select('b_name,name,s_table,t_table,i_table,logo')
        .eq('uid', usrParam)
        .single();
      if (error || !data) {
        alert('ì‚¬ìš©ì ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        throw error || new Error('No user data');
      }
      config = data;
      // í—¤ë”/íƒ€ì´í‹€ ì—…ë°ì´íŠ¸
      document.getElementById('logoImg').src = config.logo;
      document.getElementById('pageTitle').textContent = `${config.b_name} ì¼ì • ëª©ë¡`;
      document.title = `${config.b_name} ì¼ì • ëª©ë¡`;
    }

    // ì²œ ë‹¨ìœ„ ì‰¼í‘œ í•¨ìˆ˜
    function numberWithCommas(x) {
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    const dayNames = ['mon','tue','wed','thu','fri','sat','sun'];
    const dayKor = { mon:'ì›”', tue:'í™”', wed:'ìˆ˜', thu:'ëª©', fri:'ê¸ˆ', sat:'í† ', sun:'ì¼' };

    // ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadSchedules(sortBy = 'date_e') {
      const showDone = document.getElementById('showDone').checked;
      const showReserved = document.getElementById('showReserved').checked;

      let { data, error } = await sb.from(config.s_table)
        .select('*')
        .order(sortBy, { ascending: true });
      if (error) return alert('ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');

      if (!showDone) data = data.filter(item => !item.done);
      if (!showReserved) data = data.filter(item => !item.res_c);

      const tbody = document.querySelector('#schedule-table tbody');
      tbody.innerHTML = '';

      data.forEach(item => {
        const unavailable = dayNames.filter(d => item[d] !== 'Y').map(d => dayKor[d]).join(', ');
        const mapQuery = encodeURIComponent(`${item.title} ${item.loca}`);
        const mapLink = `https://map.naver.com/v5/search/${mapQuery}`;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" ${item.done ? 'checked' : ''} onchange="toggleDone(${item.id}, this.checked)"></td>
          <td><input type="checkbox" ${item.res_c ? 'checked' : ''} onchange="toggleRes(${item.id}, this.checked)"></td>
          <td><a href='edit.html?id=${item.id}&usr=${usrParam}'>${item.title}</a></td>
          <td>${numberWithCommas(parseInt(item.cost)||0)}</td>
          <td><span class="link-button" onclick="window.open('${mapLink}','_blank')">${item.loca}</span></td>
          <td>${item.date_s}</td>
          <td>${item.date_ec || item.date_e}</td>
          <td>${unavailable}</td>
          <td>${item.office||''}</td>
          <td><button onclick="location.href='goai.html?id=${item.id}&usr=${usrParam}'">AI</button></td>
          <td><button onclick="deleteSchedule(${item.id})">ì‚­ì œ</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ì‚­ì œ ë° í† ê¸€
    async function deleteSchedule(id) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      await sb.from(config.s_table).delete().eq('id', id);
      loadSchedules(document.getElementById('sort').value);
    }
    async function toggleDone(id, checked) {
      await sb.from(config.s_table).update({ done: checked }).eq('id', id);
    }
    async function toggleRes(id, checked) {
      await sb.from(config.s_table).update({ res_c: checked }).eq('id', id);
    }

    // ì´ˆê¸° ë¡œë”©
    document.getElementById('sort').addEventListener('change', e => loadSchedules(e.target.value));
    document.getElementById('showDone').addEventListener('change', () => loadSchedules(document.getElementById('sort').value));
    document.getElementById('showReserved').addEventListener('change', () => loadSchedules(document.getElementById('sort').value));

    document.addEventListener('DOMContentLoaded', async () => {
      await loadUserConfig();
      document.getElementById('btnAdd').onclick = () => location.href = `index.html?usr=${usrParam}`;
      document.getElementById('btnCal').onclick = () => location.href = `cal.html?usr=${usrParam}`;
      document.getElementById('btnRes').onclick = () => location.href = `cal_res.html?usr=${usrParam}`;
      loadSchedules('date_e');
    });
  </script>
</body>
</html>
