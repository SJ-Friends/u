<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë¡œë”© ì¤‘â€¦</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f9f9f9;
      padding: 40px;
      max-width: 1000px;
      margin: auto;
    }
    .header { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px; }
    .header img { height: 40px; }
    .header h1 { margin: 0; font-size: 1.6em; }
    .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    #calendar { background: white; border-radius: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding: 10px; }
    #legend { margin-top: 25px; padding: 10px; background: #fff; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 14px; }
    .legend-item { display: inline-block; margin-right: 15px; margin-bottom: 6px; }
    .legend-color { display: inline-block; width: 14px; height: 14px; vertical-align: middle; border-radius: 3px; margin-right: 6px; }
    button { padding: 8px 14px; background-color: #1d72b8; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
    button:hover { background-color: #135a96; }
    .fc .fc-button { background-color: #1d72b8; border: none; border-radius: 6px; padding: 8px 14px; font-size: 14px; }
    .fc .fc-button:hover { background-color: #135a96; }
    .fc .fc-toolbar-title { font-size: 1.4em; font-weight: bold; color: #333; }
    .modal-overlay { display: none; position: fixed; top:0; left:0; right:0; bottom:0; background-color: rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center; opacity:0; transition: opacity 0.3s ease; }
    .modal-overlay.show { display:flex; opacity:1; }
    .modal { position: relative; background:#fffbe6; border-radius:8px; padding:30px; max-width:700px; width:90%; max-height:90vh; overflow-y:auto; box-shadow:0 10px 25px rgba(0,0,0,0.3); animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { transform: translateY(20px); opacity:0;} to { transform: translateY(0); opacity:1;} }
    .modal .close-btn { position:absolute; top:15px; right:20px; color:#333; background:none; border:none; font-size:24px; font-weight:bold; cursor:pointer; }
    .modal .close-btn:hover { color:#000; }
    .modal h2 { margin-top:0; }
    .modal ul { padding-left:20px; line-height:1.6; }
    .modal .link-button { color:#0077cc; text-decoration:underline; cursor:pointer; }
    .modal .small-note { font-size:0.9em; color:#555; }
    /* field ê·¸ë£¹ ìŠ¤íƒ€ì¼ */
    .field-group {
      display: flex;
      flex-wrap: wrap;
      gap: 30px;
      margin-top: 22px;
      margin-bottom: 30px;
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-start;
    }
    .btn-group {
      display: flex;
      gap: 5px;
      margin-top: 2px;
    }
    textarea { font-size:15px; padding:8px; border-radius:6px; border:1px solid #d7d7d7;}

    /* ğŸ”´ ì¶”ê°€: graBtn(ì›”ë³„ê·¸ë˜í”„)ë§Œ ë¶‰ì€ìƒ‰ìœ¼ë¡œ */
    .fc .fc-graBtn-button {
      background-color: #d93025 !important; /* êµ¬ê¸€ ë ˆë“œ í†¤ */
      color: #fff !important;
      border: none !important;
    }
    .fc .fc-graBtn-button:hover {
      background-color: #b1271b !important;
    }
  </style>
</head>
<body>
  <div class="header">
    <img id="logoImg" src="logo.jpg" alt="ë¡œê³ ">
    <h1 id="pageTitle">ë¡œë”©ì¤‘... SJ</h1>
  </div>

  <div class="controls">
    <label><input type="checkbox" id="showDone" /> ì™„ë£Œ ì¼ì • í¬í•¨</label>
    <div style="display:flex; gap:10px;">
      <button id="btnNew">â• ìƒˆ ì¼ì • ë“±ë¡</button>
      <button id="btnList">ğŸ“‹ ëª©ë¡ ë³´ê¸°</button>
      <button id="btnMap">ğŸ—ºï¸ ì§€ë„ ë³´ê¸°</button>
      <button id="btnRes">ğŸ“… ì˜ˆì•½ìº˜ë¦°ë”</button>
    </div>
  </div>

  <div id='calendar'></div>
  <div id="legend"></div>

  <!-- ë¬¸êµ¬ ì‘ì„± ìƒì 2ê°œ(ìµœì´ˆ invi/ ë‘ë²ˆì§¸ invi2) -->
  <div class="field-group">
    <!-- inviìš© -->
    <div class="field">
      <label for="finalSentence"><b>Memo 1</b></label>
      <textarea id="finalSentence" rows="7" style="width:370px;"></textarea>
      <div class="btn-group">
        <button onclick="copySentence()">ë³µì‚¬</button>
        <button onclick="clearSentence()">ì§€ìš°ê¸°</button>
        <button onclick="saveSentence()">ì €ì¥</button>
      </div>
    </div>
    <!-- invi2ìš© -->
    <div class="field">
      <label for="finalSentence2"><b>Memo 2</b></label>
      <textarea id="finalSentence2" rows="7" style="width:370px;"></textarea>
      <div class="btn-group">
        <button onclick="copySentence2()">ë³µì‚¬</button>
        <button onclick="clearSentence2()">ì§€ìš°ê¸°</button>
        <button onclick="saveSentence2()">ì €ì¥</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="reportModal">
    <div class="modal">
      <button class="close-btn" onclick="closeModal()">âœ–</button>
      <h2 id="modalTitle">Report</h2>
      <div id="modalContent">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
  </div>

<!-- ë³µì‚¬ Toast ë©”ì‹œì§€ -->
<div id="toast" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#0cb5cf;color:white;padding:10px 20px;border-radius:6px;opacity:0;transition:opacity 0.3s.ease;z-index:9999;">
  ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!
</div>


<script>
  // âœ… í•µì‹¬ ìˆ˜ì •: supabase(ì „ì—­ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì´ë¦„)ì™€ ê²¹ì¹˜ì§€ ì•Šê²Œ í´ë¼ì´ì–¸íŠ¸ ë³€ìˆ˜ëª…ì„ ë³€ê²½
  const sb = window.supabase.createClient(
    'https://xxmtxuhcdzidhrefrvwf.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4bXR4dWhjZHppZGhyZWZydndmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQwODAyNTQsImV4cCI6MjA1OTY1NjI1NH0.TaCCDlJvKrif_pZY038Qkglip8h-Qqjp2w2GlKwvoVg'
  );

  // URLì—ì„œ usr íŒŒë¼ë¯¸í„° ì¶”ì¶œ
  const urlParams = new URLSearchParams(window.location.search);
  const usrParam = urlParams.get('usr');
  if (!usrParam) {
    alert('ìœ íš¨í•œ ì‚¬ìš©ì íŒŒë¼ë¯¸í„°(usr)ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
    throw new Error('Missing usr parameter');
  }


function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg || 'ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!';
  toast.style.opacity = '1';
  setTimeout(() => { toast.style.opacity = '0'; }, 1000);
}



  // ì‚¬ìš©ì ì„¤ì • ë¡œë“œ
  let config;
  async function loadUserConfig() {
    const { data, error } = await sb
      .from('usr')
      .select('b_name,name,s_table,t_table,i_table,logo')
      .eq('uid', usrParam)
      .single();
    if (error || !data) {
      console.error('ì‚¬ìš©ì ì„¤ì • ë¡œë“œ ì—ëŸ¬:', error);
      alert('ì‚¬ìš©ì ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
      throw error || new Error('No user data');
    }
    config = data;
  }

  // ì²œ ë‹¨ìœ„ ì‰¼í‘œ í•¨ìˆ˜
  function numberWithCommas(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }

  // finalSentence ë° finalSentence2 ë¡œë“œ/ì €ì¥
  async function loadSentence() {
    const { data } = await sb.from(config.i_table)
      .select('invi, invi2').order('id', { ascending: false }).limit(1);
    if (data.length) {
      document.getElementById('finalSentence').value = data[0].invi || '';
      document.getElementById('finalSentence2').value = data[0].invi2 || '';
    }
  }


// ìµœì‹  invi ë ˆì½”ë“œ(id, invi, invi2) ê°€ì ¸ì˜¤ê¸°
async function getLatestInviRow() {
  const { data } = await sb
    .from(config.i_table)
    .select('id, invi, invi2')
    .order('id', { ascending: false })
    .limit(1);
  return data.length ? data[0] : null;
}

// invi ì €ì¥ (update ë˜ëŠ” insert)
async function saveSentence() {
  const text = document.getElementById('finalSentence').value;
  const latest = await getLatestInviRow();
  if (latest) {
    // ìµœì‹  ë ˆì½”ë“œ update
    const { error } = await sb
      .from(config.i_table)
      .update({ invi: text })
      .eq('id', latest.id);
    if (error) alert('ì €ì¥ ì‹¤íŒ¨:' + error.message);
    else alert('ì €ì¥ ì™„ë£Œ!');
  } else {
    // ë°ì´í„° ì—†ìœ¼ë©´ ìƒˆ ë ˆì½”ë“œ insert
    const { error } = await sb
      .from(config.i_table)
      .insert({ invi: text });
    if (error) alert('ì €ì¥ ì‹¤íŒ¨:' + error.message);
    else alert('ì €ì¥ ì™„ë£Œ!');
  }
}

// invi2 ì €ì¥ (update ë˜ëŠ” insert)
async function saveSentence2() {
  const text2 = document.getElementById('finalSentence2').value;
  const latest = await getLatestInviRow();
  if (latest) {
    // ìµœì‹  ë ˆì½”ë“œ update
    const { error } = await sb
      .from(config.i_table)
      .update({ invi2: text2 })
      .eq('id', latest.id);
    if (error) alert('ì €ì¥ ì‹¤íŒ¨:' + error.message);
    else alert('ì €ì¥ ì™„ë£Œ!');
  } else {
    // ë°ì´í„° ì—†ìœ¼ë©´ ìƒˆ ë ˆì½”ë“œ insert
    const { error } = await sb
      .from(config.i_table)
      .insert({ invi2: text2 });
    if (error) alert('ì €ì¥ ì‹¤íŒ¨:' + error.message);
    else alert('ì €ì¥ ì™„ë£Œ!');
  }
}


  // invi ì§€ìš°ê¸°/ë³µì‚¬
  function clearSentence() { document.getElementById('finalSentence').value = ''; }
 
 function copySentence() {
   const ta = document.getElementById('finalSentence');
  ta.select();
  document.execCommand('copy');
  showToast();
  }

  // invi2 ì§€ìš°ê¸°/ë³µì‚¬
  function clearSentence2() { document.getElementById('finalSentence2').value = ''; }
function copySentence2() {
  const ta2 = document.getElementById('finalSentence2');
  ta2.select();
  document.execCommand('copy');
  showToast();
}

  function closeModal() {
    const m = document.getElementById('reportModal');
    m.classList.remove('show');
    setTimeout(() => m.style.display = 'none', 300);
  }
  async function openModal(dateStr) {
    const modal = document.getElementById('reportModal');
    document.getElementById('modalTitle').textContent = `${config.b_name} ${dateStr} Report`;
    document.getElementById('modalContent').innerHTML = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('show'), 10);
    const today = new Date(dateStr);
    const names = ['sun','mon','tue','wed','thu','fri','sat'];
    const now = names[today.getDay()];
    const { data } = await sb.from(config.s_table).select('*');
    const avail = [], dead = [], week = [];
    const getNext = (f, d) => { const dd = new Date(f); dd.setDate(dd.getDate() + (d + 7 - dd.getDay()) % 7); return dd; };
    const thisF = getNext(today, 5), thisS = getNext(today, 6), thisU = getNext(today, 0);
    const nextF = new Date(thisF); nextF.setDate(thisF.getDate() + 7);
    const nextS = new Date(thisS); nextS.setDate(thisS.getDate() + 7);
    const nextU = new Date(thisU); nextU.setDate(thisU.getDate() + 7);
    const inRange = (d, s, e) => d >= s && d <= e;
    data.forEach(i => {
      if (i.done) return;
      const s = new Date(i.date_s), e = new Date(i.date_e);
      if (i[now] === 'Y' && s <= today && e >= today) avail.push(i);
      const diff = Math.ceil((e - today) / (1000*60*60*24));
      if (diff >= 0 && diff <= 6) dead.push(i);
      const hasCur = [thisF, thisS, thisU].some(d => inRange(d, today, e));
      const hasNex = [nextF, nextS, nextU].some(d => inRange(d, today, e));
      if (hasCur && !hasNex) week.push(i);
    });
    const makeList = list => list.map(i => {
      const mapQ = encodeURIComponent(`${i.title} ${i.loca}`);
      const d = new Date(i.date_e), diff = Math.ceil((d - today) / (1000*60*60*24));
      const dDay = diff === 0 ? 'D-DAY' : `D-${diff}`;
      let resStr = '';
      if (i.res_d) { const rd = new Date(i.res_d); rd.setHours(rd.getHours()+9); resStr = ` <span style="color:red;">ì˜ˆì•½ì¼ì: ${rd.getMonth()+1}ì›” ${rd.getDate()}ì¼ ${rd.getHours()}ì‹œ</span>`; }
      const unavailable = Object.entries({sun:'ì¼',mon:'ì›”',tue:'í™”',wed:'ìˆ˜',thu:'ëª©',fri:'ê¸ˆ',sat:'í† '})
        .filter(([k,v]) => i[k] !== 'Y').map(([k,v]) => v).join(',') || 'ì—†ìŒ';
      return `<li><strong><a href="edit.html?id=${i.id}&usr=${usrParam}" style="text-decoration:none;color:inherit;">${i.title}</a></strong> ` +
             `(<span class="link-button" onclick="window.open('https://map.naver.com/v5/search/${mapQ}','_blank')">${i.loca}</span> / ` +
             `${numberWithCommas(parseInt(i.cost)||0)}ì›${resStr})<div class="small-note">ë¶ˆê°€ëŠ¥ìš”ì¼: ${unavailable}</div>` +
             `<div class="small-note">ë§ˆê°ì¼: ${i.date_e} (${dDay})</div></li>`;
    }).join('');
    document.getElementById('modalContent').innerHTML =
      `<h3>âœ… ì²´í—˜ê°€ëŠ¥ëŒ€ìƒ (${avail.length}ê±´)</h3><ul>${makeList(avail)}</ul>` +
      `<h3>â° ë§ˆê°ì„ë°• (${dead.length}ê±´)</h3><ul>${makeList(dead)}</ul>` +
      `<h3>ğŸ”¥ ì´ë²ˆ ì£¼ë§ì´ ë§ˆì§€ë§‰! (${week.length}ê±´)</h3><ul>${makeList(week)}</ul>`;
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadUserConfig().then(() => {
      // header ë° title ì—…ë°ì´íŠ¸
      document.getElementById('logoImg').src = config.logo;
      document.getElementById('pageTitle').textContent = `${config.b_name} ìº˜ë¦°ë” ë³´ê¸°`;
      document.title = `${config.b_name} ìº˜ë¦°ë” ë³´ê¸°`;
      // ë‚´ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ì—…ë°ì´íŠ¸
      document.getElementById('btnNew').onclick = () => location.href = `index.html?usr=${usrParam}`;
      document.getElementById('btnList').onclick = () => location.href = `list.html?usr=${usrParam}`;
      document.getElementById('btnMap').onclick = () => location.href = `map.html?usr=${usrParam}`;
      document.getElementById('btnRes').onclick = () => location.href = `cal_res.html?usr=${usrParam}`;
      // load final sentence ë° ìº˜ë¦°ë”
      loadSentence();
      const calendar = new FullCalendar.Calendar(document.getElementById('calendar'),{
        initialView:'dayGridMonth', locale:'ko', firstDay:1, height:'auto',
        headerToolbar:{left:'prevBtn,nextBtn todayBtn',center:'title',right:'graBtn doneBtn'}, /* â† ì—¬ê¸°: graBtnì„ doneBtn ì™¼ìª½ì— */
        customButtons:{
          prevBtn:{text:'â—',click:()=>calendar.prev()},
          nextBtn:{text:'â–·',click:()=>calendar.next()},
          todayBtn:{text:'ğŸ“ ì´ë²ˆë‹¬',click:()=>calendar.today()},
          /* ğŸ”´ ì¶”ê°€: ì›”ë³„ ê·¸ë˜í”„ ë²„íŠ¼ */
          graBtn:{text:'ğŸ“Š ì›”ë³„ê·¸ë˜í”„', click:()=>location.href = `gra.html?usr=${usrParam}`},
          doneBtn:{text:'ğŸ“ˆ ì›”ê°„ì‹¤ì ',click:()=>location.href = `done.html?usr=${usrParam}`}
        },
        titleFormat:{year:'numeric',month:'long'},
        dayCellContent:args=>({html:args.date.getDate().toString()}),
        events:async()=>{
          const chk = document.getElementById('showDone').checked;
          let { data } = await sb.from(config.s_table).select('*');
          if (!chk) data = data.filter(i=>!i.done);
          const offs=[...new Set(data.map(i=>i.office||'ê¸°íƒ€'))];
          const pal=['#e9fdc8','#c4f2dc','#fddd85','#f9cccc','#bbcbf6'];
          const cmap={}; offs.forEach((o,i)=>cmap[o]=pal[i%pal.length]);
          document.getElementById('legend').innerHTML = '<strong>ì²´í—˜ë‹¨ë³„ ìƒ‰ìƒ:</strong><br>' + offs.map(o=>`<span class="legend-item"><span class="legend-color" style="background:${cmap[o]}"></span>${o}</span>`).join('');
          return data.map(i=>({id:i.id,title:`${i.title} (${numberWithCommas(parseInt(i.cost)||0)}ì›)`,start:i.date_s,end:i.date_e?new Date(new Date(i.date_e).getTime()+86400000).toISOString().split('T')[0]:i.date_s,backgroundColor:i.done?'#ccc':cmap[i.office||'ê¸°íƒ€'],borderColor:i.done?'#ccc':cmap[i.office||'ê¸°íƒ€'],textColor:'#000',extendedProps:{id:i.id}}));
        },
        eventClick:info=>{if(confirm('ì´ ì¼ì •ì„ ê´€ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) location.href = `edit.html?id=${info.event.extendedProps.id}&usr=${usrParam}`;},
        dateClick:info=>openModal(info.dateStr)
      });
      calendar.render();
      document.getElementById('showDone').addEventListener('change',()=>calendar.refetchEvents());
    }).catch(err=>console.error(err));
  });
</script>
</body>
</html>
