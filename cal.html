<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <!-- DB에서 로드된 b_name으로 덮어쓰기 -->
  <title>로딩 중…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* (기존 스타일 그대로 유지) */
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    .header { display: flex; align-items: center; padding: 10px; background: #f5f5f5; }
    .header img { height: 40px; margin-right: 10px; }
    .controls { padding: 10px; background: #fff; display: flex; justify-content: space-between; align-items: center; }
    #calendar { max-width: 900px; margin: 20px auto; }
    .legend-item { margin-right: 8px; display: inline-block; }
    .legend-color { display: inline-block; width: 12px; height: 12px; margin-right: 4px; vertical-align: middle; }
  </style>
</head>
<body>
  <div class="header">
    <img id="logoImg" src="" alt="로고" />
    <h1 id="pageTitle">로딩 중…</h1>
  </div>

  <div class="controls">
    <div>
      <button id="btnNew">➕ 새 일정 등록</button>
      <button id="btnList">📋 목록 보기</button>
      <button id="btnMap">🗺️ 지도 보기</button>
    </div>
    <label><input type="checkbox" id="showDone" checked /> 완료 포함</label>
  </div>

  <div id="calendar"></div>
  <div id="legend"></div>

  <script>
    // Supabase 클라이언트 초기화
    const supabase = window.supabase.createClient(
      'https://xxmtxuhcdzidhrefrvwf.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpZVCJ9…TaCCDlJvKrif_pZY038Qkglip8h-Qqjp2w2GlKwvoVg'
    );

    // URL에서 usr 파라미터 추출
    const urlParams = new URLSearchParams(window.location.search);
    const usrParam = urlParams.get('usr');
    if (!usrParam) {
      alert('유효한 사용자 파라미터(usr)가 필요합니다.');
      throw new Error('Missing usr parameter');
    }

    // 사용자 설정을 담을 객체
    let config;
    async function loadUserConfig() {
      const { data, error } = await supabase
        .from('usr')
        .select('b_name,name,s_table,t_table,i_table,logo')
        .eq('uid', usrParam)
        .single();  // uid가 반드시 존재하므로 single 사용

      if (error || !data) {
        console.error('Supabase load error:', error);
        alert('사용자 설정을 불러오지 못했습니다.');
        throw error || new Error('No user data');
      }
      config = data;
    }

    (async function init() {
      // 1) 사용자 설정 로드
      await loadUserConfig();

      // 2) 헤더, 타이틀, 로고 반영
      document.title = `${config.b_name} 캘린더 보기`;
      document.getElementById('pageTitle').textContent = `${config.b_name} 캘린더 보기`;
      document.getElementById('logoImg').src = config.logo;

      // 3) 네비게이션 버튼에 usr 파라미터 유지
      document.getElementById('btnNew').onclick  = () => window.location.href = `index.html?usr=${usrParam}`;
      document.getElementById('btnList').onclick = () => window.location.href = `list.html?usr=${usrParam}`;
      document.getElementById('btnMap').onclick  = () => window.location.href = `map.html?usr=${usrParam}`;

      // 4) FullCalendar 렌더링
      const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
        initialView: 'dayGridMonth',
        locale: 'ko',
        firstDay: 1,
        height: 'auto',
        headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
        events: async () => {
          const { data, error } = await supabase.from(config.s_table).select('*');
          if (error) {
            console.error('이벤트 로드 에러:', error);
            return [];
          }
          const arr = data.filter(i => document.getElementById('showDone').checked || !i.done);
          const offices = [...new Set(arr.map(i => i.office || '기타'))];
          const palette = ['#e9fdc8','#c4f2dc','#fddd85','#f9cccc','#bbcbf6'];
          const cmap = {};
          offices.forEach((o, idx) => cmap[o] = palette[idx % palette.length]);
          document.getElementById('legend').innerHTML =
            '<strong>체험단별 색상:</strong><br>' +
            offices.map(o => `<span class="legend-item"><span class="legend-color" style="background:${cmap[o]}"></span>${o}</span>`).join('');

          return arr.map(i => ({
            id: i.id,
            title: `${i.title} (${i.cost?.toLocaleString()}원)`,           
            start: i.date_s,
            end: i.date_e ? new Date(new Date(i.date_e).getTime()+86400000).toISOString().split('T')[0] : i.date_s,
            backgroundColor: i.done ? '#ccc' : cmap[i.office || '기타'],
            borderColor:     i.done ? '#ccc' : cmap[i.office || '기타'],
            textColor: '#000'
          }));
        },
        eventClick: info => {
          if (confirm('이 일정을 관리하시겠습니까?')) {
            window.location.href = `edit.html?id=${info.event.id}&usr=${usrParam}`;
          }
        }
      });
      calendar.render();

      // 5) 완료 포함 체크박스 변경 시 리로드
      document.getElementById('showDone').onchange = () => calendar.refetchEvents();
    })();
  </script>
</body>
</html>
