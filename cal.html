<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <!-- DBì—ì„œ ë¡œë“œëœ b_nameìœ¼ë¡œ ë®ì–´ì“°ê¸° -->
  <title>ë¡œë”© ì¤‘â€¦</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ê·¸ëŒ€ë¡œ ìœ ì§€) */
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    .header { display: flex; align-items: center; padding: 10px; background: #f5f5f5; }
    .header img { height: 40px; margin-right: 10px; }
    .controls { padding: 10px; background: #fff; display: flex; justify-content: space-between; align-items: center; }
    #calendar { max-width: 900px; margin: 20px auto; }
    .legend-item { margin-right: 8px; display: inline-block; }
    .legend-color { display: inline-block; width: 12px; height: 12px; margin-right: 4px; vertical-align: middle; }
  </style>
</head>
<body>
  <div class="header">
    <img id="logoImg" src="" alt="ë¡œê³ " />
    <h1 id="pageTitle">ë¡œë”© ì¤‘â€¦</h1>
  </div>

  <div class="controls">
    <div>
      <button id="btnNew">â• ìƒˆ ì¼ì • ë“±ë¡</button>
      <button id="btnList">ğŸ“‹ ëª©ë¡ ë³´ê¸°</button>
      <button id="btnMap">ğŸ—ºï¸ ì§€ë„ ë³´ê¸°</button>
    </div>
    <label><input type="checkbox" id="showDone" checked /> ì™„ë£Œ í¬í•¨</label>
  </div>

  <div id="calendar"></div>
  <div id="legend"></div>

  <script>
    // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
    const supabase = window.supabase.createClient(
      'https://xxmtxuhcdzidhrefrvwf.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpZVCJ9â€¦TaCCDlJvKrif_pZY038Qkglip8h-Qqjp2w2GlKwvoVg'
    );

    // URLì—ì„œ usr íŒŒë¼ë¯¸í„° ì¶”ì¶œ
    const urlParams = new URLSearchParams(window.location.search);
    const usrParam = urlParams.get('usr');
    if (!usrParam) {
      alert('ìœ íš¨í•œ ì‚¬ìš©ì íŒŒë¼ë¯¸í„°(usr)ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
      throw new Error('Missing usr parameter');
    }

    // ì‚¬ìš©ì ì„¤ì •ì„ ë‹´ì„ ê°ì²´
    let config;
    async function loadUserConfig() {
      const { data, error } = await supabase
        .from('usr')
        .select('b_name,name,s_table,t_table,i_table,logo')
        .eq('uid', usrParam)
        .single();  // uidê°€ ë°˜ë“œì‹œ ì¡´ì¬í•˜ë¯€ë¡œ single ì‚¬ìš©

      if (error || !data) {
        console.error('Supabase load error:', error);
        alert('ì‚¬ìš©ì ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        throw error || new Error('No user data');
      }
      config = data;
    }

    (async function init() {
      // 1) ì‚¬ìš©ì ì„¤ì • ë¡œë“œ
      await loadUserConfig();

      // 2) í—¤ë”, íƒ€ì´í‹€, ë¡œê³  ë°˜ì˜
      document.title = `${config.b_name} ìº˜ë¦°ë” ë³´ê¸°`;
      document.getElementById('pageTitle').textContent = `${config.b_name} ìº˜ë¦°ë” ë³´ê¸°`;
      document.getElementById('logoImg').src = config.logo;

      // 3) ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ì— usr íŒŒë¼ë¯¸í„° ìœ ì§€
      document.getElementById('btnNew').onclick  = () => window.location.href = `index.html?usr=${usrParam}`;
      document.getElementById('btnList').onclick = () => window.location.href = `list.html?usr=${usrParam}`;
      document.getElementById('btnMap').onclick  = () => window.location.href = `map.html?usr=${usrParam}`;

      // 4) FullCalendar ë Œë”ë§
      const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
        initialView: 'dayGridMonth',
        locale: 'ko',
        firstDay: 1,
        height: 'auto',
        headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
        events: async () => {
          const { data, error } = await supabase.from(config.s_table).select('*');
          if (error) {
            console.error('ì´ë²¤íŠ¸ ë¡œë“œ ì—ëŸ¬:', error);
            return [];
          }
          const arr = data.filter(i => document.getElementById('showDone').checked || !i.done);
          const offices = [...new Set(arr.map(i => i.office || 'ê¸°íƒ€'))];
          const palette = ['#e9fdc8','#c4f2dc','#fddd85','#f9cccc','#bbcbf6'];
          const cmap = {};
          offices.forEach((o, idx) => cmap[o] = palette[idx % palette.length]);
          document.getElementById('legend').innerHTML =
            '<strong>ì²´í—˜ë‹¨ë³„ ìƒ‰ìƒ:</strong><br>' +
            offices.map(o => `<span class="legend-item"><span class="legend-color" style="background:${cmap[o]}"></span>${o}</span>`).join('');

          return arr.map(i => ({
            id: i.id,
            title: `${i.title} (${i.cost?.toLocaleString()}ì›)`,           
            start: i.date_s,
            end: i.date_e ? new Date(new Date(i.date_e).getTime()+86400000).toISOString().split('T')[0] : i.date_s,
            backgroundColor: i.done ? '#ccc' : cmap[i.office || 'ê¸°íƒ€'],
            borderColor:     i.done ? '#ccc' : cmap[i.office || 'ê¸°íƒ€'],
            textColor: '#000'
          }));
        },
        eventClick: info => {
          if (confirm('ì´ ì¼ì •ì„ ê´€ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            window.location.href = `edit.html?id=${info.event.id}&usr=${usrParam}`;
          }
        }
      });
      calendar.render();

      // 5) ì™„ë£Œ í¬í•¨ ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ ë¦¬ë¡œë“œ
      document.getElementById('showDone').onchange = () => calendar.refetchEvents();
    })();
  </script>
</body>
</html>
