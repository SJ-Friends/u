<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë¡œë”© ì¤‘â€¦</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f4f4;
      max-width: 1000px;
      margin: auto;
      padding: 40px 20px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    h1 {
      margin: 0;
      color: #333;
    }
    select, button {
      padding: 8px 12px;
      font-size: 14px;
      margin-left: 10px;
    }
    button {
      background: #1d72b8;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background: #135a96;
    }
    .summary, .list {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin-bottom: 30px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 10px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }
    th {
      background-color: #f0f0f0;
      font-weight: bold;
    }
    .stat-box {
      display: flex;
      justify-content: space-around;
      margin-bottom: 20px;
      font-size: 1.1em;
    }
    .stat-box div {
      background: #eef;
      padding: 15px 20px;
      border-radius: 8px;
    }
    .highlight {
      font-weight: bold;
      color: #1d72b8;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <h1 id="reportTitle">ğŸ“ˆ ì‹¤ì  ë¦¬í¬íŠ¸</h1>
    <div>
      <select id="monthSelect"></select>
      <button id="btnMap">ğŸ—ºï¸ ì§€ë„ ë³´ê¸°</button>
      <button id="btnCal">ğŸ“… ìº˜ë¦°ë”ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>
  </div>

  <div class="summary">
    <h2>âœ… ì „ì²´ ìš”ì•½</h2>
    <div class="stat-box" id="totalStats"></div>
    <h2>ğŸ“Š ì²´í—˜ë‹¨ë³„ ìš”ì•½</h2>
    <table id="officeTable">
      <thead>
        <tr>
          <th>ì²´í—˜ë‹¨</th>
          <th>ì™„ë£Œê±´ìˆ˜</th>
          <th>ì´ ê¸ˆì•¡</th>
          <th>í‰ê·  ê¸ˆì•¡</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="list">
    <h2>ğŸ“‹ ì™„ë£Œ ì¼ì • ëª©ë¡</h2>
    <table id="doneList">
      <thead>
        <tr>
          <th>ìˆœë²ˆ</th>
          <th>ì—…ì²´ëª…</th>
          <th>ì²´í—˜ë‹¨</th>
          <th>ìœ„ì¹˜</th>
          <th>ì§€ì›ê¸ˆì•¡</th>
          <th>ì¢…ë£Œì¼</th>
          <th>ë©”ëª¨</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const sb = window.supabase.createClient(
      'https://xxmtxuhcdzidhrefrvwf.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4bXR4dWhjZHppZGhyZWZydndmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQwODAyNTQsImV4cCI6MjA1OTY1NjI1NH0.TaCCDlJvKrif_pZY038Qkglip8h-Qqjp2w2GlKwvoVg'
    );

    // === ì‚¬ìš©ì ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ===
    const urlParams = new URLSearchParams(window.location.search);
    const usrParam = urlParams.get('usr');
    if (!usrParam) {
      alert('ìœ íš¨í•œ ì‚¬ìš©ì íŒŒë¼ë¯¸í„°(usr)ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
      throw new Error('Missing usr parameter');
    }

    let config;
    async function loadUserConfig() {
      const { data, error } = await supabase
        .from('usr')
        .select('b_name,name,s_table,t_table,i_table,logo')
        .eq('uid', usrParam)
        .single();
      if (error || !data) {
        alert('ì‚¬ìš©ì ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        throw error || new Error('No user data');
      }
      config = data;
    }

    function formatCost(value) {
      const num = parseInt(value, 10);
      if (isNaN(num)) return 0;
      return num;
    }

    function formatCurrency(value) {
      return value.toLocaleString() + 'ì›';
    }

    function getMonthRange(year, month) {
      const start = new Date(year, month - 1, 1);
      const end = new Date(year, month, 0);
      return [start, end];
    }

    function updateTitle(year, month) {
      document.getElementById('reportTitle').textContent = `ğŸ“ˆ ${config.b_name} ì‹¤ì  ë¦¬í¬íŠ¸`;
      document.title = `ğŸ“ˆ ${config.b_name} ${year}ë…„ ${month.toString().padStart(2, '0')}ì›” ì‹¤ì  ë¦¬í¬íŠ¸`;
    }

    function renderMonthSelect() {
      const select = document.getElementById('monthSelect');
      const now = new Date();
      const currentYear = now.getFullYear();
      const currentMonth = now.getMonth() + 1;

      select.innerHTML = '';
      for (let i = 0; i < 12; i++) {
        const date = new Date(currentYear, currentMonth - 1 - i);
        const y = date.getFullYear();
        const m = (date.getMonth() + 1).toString().padStart(2, '0');
        const option = document.createElement('option');
        option.value = `${y}-${m}`;
        option.text = `${y}ë…„ ${m}ì›”`;
        select.appendChild(option);
      }

      select.value = `${currentYear}-${currentMonth.toString().padStart(2, '0')}`;
      select.addEventListener('change', () => {
        const [y, m] = select.value.split('-');
        loadDoneData(parseInt(y), parseInt(m));
      });
    }

    async function loadDoneData(year, month) {
      updateTitle(year, month);
      const { data, error } = await sb.from(config.s_table).select('*');
      if (error) {
        alert('ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
        return;
      }

      const [start, end] = getMonthRange(year, month);
      const doneList = data.filter(item => {
        if (!item.done || !item.date_e) return false;
        const date = new Date(item.date_e);
        return date >= start && date <= end;
      });

      renderStatistics(doneList);
      renderList(doneList);
    }

    function renderStatistics(list) {
      const totalCount = list.length;
      const totalAmount = list.reduce((sum, item) => sum + formatCost(item.cost), 0);
      const avgAmount = totalCount > 0 ? Math.round(totalAmount / totalCount) : 0;

      document.getElementById('totalStats').innerHTML = `
        <div>ì™„ë£Œê±´ìˆ˜: <span class="highlight">${totalCount}ê±´</span></div>
        <div>ì´ ì§€ì›ê¸ˆì•¡: <span class="highlight">${formatCurrency(totalAmount)}</span></div>
        <div>í‰ê·  ì§€ì›ê¸ˆì•¡: <span class="highlight">${formatCurrency(avgAmount)}</span></div>
      `;

      const officeStats = {};
      for (const item of list) {
        const office = item.office || 'ê¸°íƒ€';
        if (!officeStats[office]) {
          officeStats[office] = { count: 0, sum: 0 };
        }
        officeStats[office].count++;
        officeStats[office].sum += formatCost(item.cost);
      }

      const tbody = document.querySelector('#officeTable tbody');
      tbody.innerHTML = '';
      for (const office in officeStats) {
        const { count, sum } = officeStats[office];
        const avg = count > 0 ? Math.round(sum / count) : 0;
        const row = `
          <tr>
            <td>${office}</td>
            <td>${count}</td>
            <td>${formatCurrency(sum)}</td>
            <td>${formatCurrency(avg)}</td>
          </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
      }
    }

    function renderList(list) {
      const tbody = document.querySelector('#doneList tbody');
      tbody.innerHTML = '';
      list.forEach((item, i) => {
        const row = `
          <tr>
            <td>${i + 1}</td>
            <td>${item.title}</td>
            <td>${item.office || 'ê¸°íƒ€'}</td>
            <td>${item.loca || '-'}</td>
            <td>${formatCurrency(formatCost(item.cost))}</td>
            <td>${item.date_e}</td>
            <td>${item.memo || ''}</td>
          </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await loadUserConfig();
      renderMonthSelect();
      const now = new Date();
      loadDoneData(now.getFullYear(), now.getMonth() + 1);

      // ë²„íŠ¼ì— usr íŒŒë¼ë¯¸í„° ìœ ì§€
      document.getElementById('btnMap').onclick = () => location.href = `map.html?usr=${usrParam}`;
      document.getElementById('btnCal').onclick = () => location.href = `cal.html?usr=${usrParam}`;
    });
  </script>
</body>
</html>
