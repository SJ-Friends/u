<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“ˆ ì›”ë³„ ì‹¤ì  ì¶”ì´</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    /* ê¸°ë³¸ ë ˆì´ì•„ì›ƒ */
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f4f4;
      max-width: 1000px;
      margin: auto;
      padding: 40px 20px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
      gap: 10px;
    }
    h1 { margin: 0; color: #333; }
    button {
      padding: 8px 12px; font-size: 14px;
      background: #1d72b8; color: #fff; border: 0; border-radius: 6px; cursor: pointer;
    }
    button:hover { background: #135a96; }
    .card {
      background: #fff; padding: 20px; border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px;
    }
    .stat {
      display: flex; gap: 12px; flex-wrap: wrap; margin-top: 10px;
    }
    .stat div {
      background: #eef; padding: 12px 14px; border-radius: 8px; font-size: 14px;
    }
    table {
      width: 100%; border-collapse: collapse; margin-top: 14px;
    }
    th, td { padding: 10px; text-align: center; border-bottom: 1px solid #eee; }
    th { background: #f0f0f0; font-weight: 600; }
    .muted { color: #666; font-size: 13px; }
    .controls { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .toggle { display: inline-flex; align-items: center; gap: 6px; user-select: none; cursor: pointer; }

    /* === ì°¨íŠ¸ ì•ˆì „ ì˜ì—­ (í•˜ë“œë‹) ===
       - ì»¨í…Œì´ë„ˆ ê³ ì • ë†’ì´ë¡œ ë ˆì´ì•„ì›ƒ ë£¨í”„ ì°¨ë‹¨
       - ìº”ë²„ìŠ¤ ì ˆëŒ€ ë°°ì¹˜ë¡œ 100% ì˜ì—­ ì±„ì›€
       - overflow:hiddenìœ¼ë¡œ ì˜ˆìƒì¹˜ ëª»í•œ í™•ì¥ ë°©ì§€ */
    .chart-wrap {
      position: relative;
      height: 360px;          /* í•„ìš” ì‹œ 300~480px ë²”ìœ„ë¡œ ì¡°ì ˆ */
      max-height: 60vh;       /* í™”ë©´ ê¸°ì¤€ ìƒí•œ */
      overflow: hidden;       /* ì»¨í…ì¸  ë„˜ì¹¨ ë°©ì§€ */
    }
    .chart-wrap canvas {
      position: absolute; inset: 0;
      width: 100% !important;
      height: 100% !important;
      display: block;         /* ì¸ë¼ì¸ ìš”ì†Œê°„ ê°„ê²© ì œê±° */
    }

    /* ê¸°íƒ€ ì•ˆì „ì¥ì¹˜ */
    html, body { min-height: 100%; }
  </style>
</head>
<body>
  <div class="top-bar">
    <h1 id="pageTitle">ğŸ“ˆ ì›”ë³„ ì‹¤ì  ì¶”ì´</h1>
    <div class="controls">
      <label class="toggle">
        <input type="checkbox" id="lineToggle" />
        ì„ í˜• ì¶”ì„¸ì„  í‘œì‹œ
      </label>
      <button id="btnReport">ğŸ“‹ ë¦¬í¬íŠ¸ë¡œ</button>
      <button id="btnMap">ğŸ—ºï¸ ì§€ë„</button>
      <button id="btnCal">ğŸ“… ìº˜ë¦°ë”</button>
    </div>
  </div>

  <div class="card">
    <div class="chart-wrap">
      <!-- height/width ì†ì„± ëª…ì‹œ X : CSSë§Œ ì‚¬ìš© -->
      <canvas id="monthlyChart"></canvas>
    </div>
    <div class="stat" id="quickStats"></div>
    <div class="muted" id="rangeInfo"></div>
  </div>

  <div class="card">
    <h2>ğŸ“‹ ì›”ë³„ ê±´ìˆ˜ í‘œ</h2>
    <table id="tblMonthly">
      <thead>
        <tr>
          <th>ì›”(YYYY-MM)</th>
          <th>ì™„ë£Œ ê±´ìˆ˜</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
  // === Supabase ì—°ê²° (ê¸°ì¡´ê³¼ ë™ì¼) ===
  const supabase = window.supabase.createClient(
    'https://xxmtxuhcdzidhrefrvwf.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4bXR4dWhjZHppZGhyZWZydndmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQwODAyNTQsImV4cCI6MjA1OTY1NjI1NH0.TaCCDlJvKrif_pZY038Qkglip8h-Qqjp2w2GlKwvoVg'
  );

  // === íŒŒë¼ë¯¸í„° ì²´í¬ ===
  const urlParams = new URLSearchParams(window.location.search);
  const usrParam = urlParams.get('usr');
  if (!usrParam) {
    alert('ìœ íš¨í•œ ì‚¬ìš©ì íŒŒë¼ë¯¸í„°(usr)ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
    throw new Error('Missing usr parameter');
  }

  // === ìƒíƒœ ===
  let config;
  let chart = null;                   // Chart.js ì¸ìŠ¤í„´ìŠ¤
  let labelsGlobal = [];              // ì›” ë¼ë²¨
  let countsGlobal = [];              // ì›”ë³„ ê±´ìˆ˜
  let initDone = false;               // ì´ˆê¸°í™” ê°€ë“œ

  // === ìœ í‹¸ ===
  const ymKey = (d) => {
    const y = d.getFullYear();
    const m = (d.getMonth() + 1).toString().padStart(2, '0');
    return `${y}-${m}`;
  };
  const addMonths = (date, months) =>
    new Date(date.getFullYear(), date.getMonth() + months, 1);
  const monthRangeKeys = (minDate, maxDate) => {
    const keys = [];
    let cur = new Date(minDate);
    while (cur <= maxDate) {
      keys.push(ymKey(cur));
      cur = addMonths(cur, 1);
    }
    return keys;
  };
  function parseDateSafe(v) {
    if (!v) return null;
    const d = new Date(v);
    return isNaN(d.getTime()) ? null : d;
  }

  async function loadUserConfig() {
    const { data, error } = await supabase
      .from('usr')
      .select('b_name,name,s_table,t_table,i_table,logo')
      .eq('uid', usrParam)
      .single();
    if (error || !data) {
      alert('ì‚¬ìš©ì ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
      throw error || new Error('No user data');
    }
    config = data;
    document.getElementById('pageTitle').textContent = `ğŸ“ˆ ${config.b_name} ì›”ë³„ ì‹¤ì  ì¶”ì´`;
    document.title = `${config.b_name} | ì›”ë³„ ì‹¤ì  ì¶”ì´`;
  }

  async function loadMonthlyCounts() {
    const { data, error } = await supabase
      .from(config.s_table)
      .select('done, date_e'); // ìµœì†Œ ì»¬ëŸ¼ë§Œ
    if (error) {
      alert('ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
      throw error;
    }

    const items = (data || []).filter(r => r && r.done && r.date_e);

    if (items.length === 0) {
      labelsGlobal = [];
      countsGlobal = [];
      renderTable(labelsGlobal, countsGlobal);
      renderChart(labelsGlobal, countsGlobal);
      document.getElementById('rangeInfo').textContent = 'ì™„ë£Œëœ ì‹¤ì  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
      document.getElementById('quickStats').innerHTML = '';
      return;
    }

    const monthDates = items
      .map(r => parseDateSafe(r.date_e))
      .filter(Boolean)
      .map(d => new Date(d.getFullYear(), d.getMonth(), 1));

    if (monthDates.length === 0) {
      labelsGlobal = [];
      countsGlobal = [];
      renderTable(labelsGlobal, countsGlobal);
      renderChart(labelsGlobal, countsGlobal);
      document.getElementById('rangeInfo').textContent = 'ìœ íš¨í•œ ì¢…ë£Œì¼(date_e)ì´ ì—†ìŠµë‹ˆë‹¤.';
      document.getElementById('quickStats').innerHTML = '';
      return;
    }

    const minDate = new Date(Math.min(...monthDates));
    const now = new Date();
    const maxDate = new Date(now.getFullYear(), now.getMonth(), 1);

    const keys = monthRangeKeys(minDate, maxDate);
    const countMap = Object.fromEntries(keys.map(k => [k, 0]));

    for (const r of items) {
      const d = parseDateSafe(r.date_e);
      if (!d) continue;
      const key = ymKey(new Date(d.getFullYear(), d.getMonth(), 1));
      if (key in countMap) countMap[key] += 1;
    }

    labelsGlobal = keys;
    countsGlobal = keys.map(k => countMap[k]);

    const total = countsGlobal.reduce((a,b)=>a+b,0);
    const activeMonths = countsGlobal.filter(c=>c>0).length;
    const avgPerMonth = labelsGlobal.length ? Math.round(total / labelsGlobal.length) : 0;

    document.getElementById('rangeInfo').textContent =
      `ê¸°ê°„: ${labelsGlobal[0]} ~ ${labelsGlobal[labelsGlobal.length - 1]} (ì´ ${labelsGlobal.length}ê°œì›”)`;

    document.getElementById('quickStats').innerHTML = `
      <div>ì´ ì™„ë£Œê±´ìˆ˜: <b>${total}</b>ê±´</div>
      <div>í™œì„± ì›”(ì‹¤ì >0): <b>${activeMonths}</b>ê°œì›”</div>
      <div>ì›” í‰ê· (ì „ì²´ ê¸°ê°„ ê¸°ì¤€): <b>${avgPerMonth}</b>ê±´</div>
    `;

    renderTable(labelsGlobal, countsGlobal);
    renderChart(labelsGlobal, countsGlobal);
  }

  function renderTable(labels, counts) {
    const tbody = document.querySelector('#tblMonthly tbody');
    tbody.innerHTML = '';
    for (let i = 0; i < labels.length; i++) {
      tbody.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${labels[i]}</td>
          <td>${counts[i]}</td>
        </tr>
      `);
    }
  }

  function renderChart(labels, counts) {
    const canvas = document.getElementById('monthlyChart');
    const ctx = canvas.getContext('2d');

    // ê¸°ì¡´ ì°¨íŠ¸ ì •ë¦¬
    if (chart) {
      chart.destroy();
      chart = null;
    }

    const showLine = document.getElementById('lineToggle').checked;

    const datasets = [
      {
        type: 'bar',
        label: 'ì›”ë³„ ì™„ë£Œ ê±´ìˆ˜',
        data: counts,
        borderWidth: 1
      }
    ];
    if (showLine) {
      datasets.push({
        type: 'line',
        label: 'ì¶”ì„¸ì„ ',
        data: counts,
        tension: 0.25,
        pointRadius: 2
      });
    }

    // === Chart.js ì˜µì…˜ í•˜ë“œë‹(ë£¨í”„ ë°©ì§€) ===
    chart = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets },
      options: {
        responsive: true,            // ë°˜ì‘í˜•ì€ ìœ ì§€
        resizeDelay: 150,            // ë¦¬ì‚¬ì´ì¦ˆ í­ì£¼ ì™„í™”
        maintainAspectRatio: false,  // ì»¨í…Œì´ë„ˆ ë†’ì´ì— ë§ì¶¤
        animation: false,            // ë¦¬í”Œë¡œìš° ìµœì†Œí™”
        plugins: {
          legend: { display: true },
          tooltip: {
            callbacks: {
              title: (items) => items?.[0]?.label ?? '',
              label: (item) => `${item.dataset.label}: ${item.parsed.y}ê±´`
            }
          }
        },
        scales: {
          x: { title: { display: true, text: 'ì›”(YYYY-MM)' } },
          y: { beginAtZero: true, title: { display: true, text: 'ê±´ìˆ˜' }, ticks: { precision: 0 } }
        }
      }
    });
  }

  // === ì•ˆì „í•œ ë‹¨ì¼ ì´ˆê¸°í™” ===
  document.addEventListener('DOMContentLoaded', async () => {
    if (initDone) return;  // ê°€ë“œ
    initDone = true;

    await loadUserConfig();
    await loadMonthlyCounts();

    // ì´ë™ ë²„íŠ¼(usr ìœ ì§€)
    document.getElementById('btnMap').onclick   = () => location.href = `map.html?usr=${usrParam}`;
    document.getElementById('btnCal').onclick   = () => location.href = `cal.html?usr=${usrParam}`;
    document.getElementById('btnReport').onclick= () => location.href = `done.html?usr=${usrParam}`;

    // í† ê¸€ì€ ì°¨íŠ¸ë§Œ ì¬ë Œë” (DOM ë³€ê²½ ì—†ìŒ)
    document.getElementById('lineToggle').addEventListener('change', () => {
      renderChart(labelsGlobal, countsGlobal);
    });
  });
</script>
</body>
</html>
