<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“ˆ ì‹¤ì  ì¶”ì´ (ì›”/ì£¼)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f4f4;
      max-width: 1000px;
      margin: auto;
      padding: 40px 20px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 16px;
      gap: 10px;
    }
    h1 { margin: 0; color: #333; }
    .controls { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    select, button { padding: 8px 12px; font-size: 14px; border-radius: 6px; }
    button { background: #1d72b8; color: #fff; border: 0; cursor: pointer; }
    button:hover { background: #135a96; }
    .card {
      background: #fff; padding: 20px; border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px;
    }
    .stat {
      display: flex; gap: 12px; flex-wrap: wrap; margin-top: 10px;
    }
    .stat div {
      background: #eef; padding: 12px 14px; border-radius: 8px; font-size: 14px;
    }
    .muted { color: #666; font-size: 13px; margin-top: 6px; }
    table { width: 100%; border-collapse: collapse; margin-top: 14px; }
    th, td { padding: 10px; text-align: center; border-bottom: 1px solid #eee; }
    th { background: #f0f0f0; font-weight: 600; }
    /* ì°¨íŠ¸ ì•ˆì „ ë˜í¼ (ë¬´í•œ ë†’ì´ ë£¨í”„ ë°©ì§€) */
    .chart-wrap {
      position: relative;
      height: 360px;      /* í•„ìš” ì‹œ 300~480px ì¡°ì ˆ */
      max-height: 60vh;
      overflow: hidden;
    }
    .chart-wrap canvas {
      position: absolute; inset: 0;
      width: 100% !important; height: 100% !important; display: block;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <h1 id="pageTitle">ğŸ“ˆ ì‹¤ì  ì¶”ì´</h1>
    <div class="controls">
      <!-- â‘  ìš”ì²­: ì´ˆê¸° ì²´í¬ ìƒíƒœ -->
      <label style="user-select:none; cursor:pointer;">
        <input type="checkbox" id="lineToggle" checked /> ì„ í˜• ì¶”ì„¸ì„  í‘œì‹œ
      </label>
      <!-- â‘¡ ìš”ì²­: ì›”/ì£¼ ë‹¨ìœ„ ì „í™˜ -->
      <label for="granularity">ë³´ê¸°:</label>
      <select id="granularity">
        <option value="month" selected>ì›” ë‹¨ìœ„</option>
        <option value="week">ì£¼ ë‹¨ìœ„</option>
      </select>
      <button id="btnReport">ğŸ“‹ ë¦¬í¬íŠ¸</button>
      <button id="btnMap">ğŸ—ºï¸ ì§€ë„</button>
      <button id="btnCal">ğŸ“… ìº˜ë¦°ë”</button>
    </div>
  </div>

  <div class="card">
    <div class="chart-wrap">
      <canvas id="trendChart"></canvas>
    </div>
    <div class="stat" id="quickStats"></div>
    <div class="muted" id="rangeInfo"></div>
  </div>

  <div class="card">
    <h2 id="tableTitle">ğŸ“‹ ì›”ë³„ ê±´ìˆ˜ í‘œ</h2>
    <table id="tblCounts">
      <thead>
        <tr>
          <th id="thLabel">ì›”(YYYY-MM)</th>
          <th>ì™„ë£Œ ê±´ìˆ˜</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
  // === Supabase ì—°ê²° ===
  const sb = window.supabase.createClient(
    'https://xxmtxuhcdzidhrefrvwf.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4bXR4dWhjZHppZGhyZWZydndmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQwODAyNTQsImV4cCI6MjA1OTY1NjI1NH0.TaCCDlJvKrif_pZY038Qkglip8h-Qqjp2w2GlKwvoVg'
  );

  // usr íŒŒë¼ë¯¸í„°
  const urlParams = new URLSearchParams(window.location.search);
  const usrParam = urlParams.get('usr');
  if (!usrParam) { alert('usr íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.'); throw new Error('Missing usr'); }

  // ìƒíƒœ
  let config;
  let chart = null;
  let itemsGlobal = [];    // ì›ë³¸ done + date_e í•­ëª©
  let labelsGlobal = [];   // í˜„ì¬ ë¼ë²¨
  let countsGlobal = [];   // í˜„ì¬ ë°ì´í„°
  let initDone = false;

  // ìœ í‹¸: ì›” ë¼ë²¨
  const ymKey = (d) => {
    const y = d.getFullYear();
    const m = (d.getMonth() + 1).toString().padStart(2, '0');
    return `${y}-${m}`;
  };
  const addMonths = (date, months) =>
    new Date(date.getFullYear(), date.getMonth() + months, 1);
  const monthRangeKeys = (minDate, maxDate) => {
    const keys = [];
    let cur = new Date(minDate);
    while (cur <= maxDate) {
      keys.push(ymKey(cur));
      cur = addMonths(cur, 1);
    }
    return keys;
  };
  function parseDateSafe(v) {
    if (!v) return null;
    const d = new Date(v);
    return isNaN(d.getTime()) ? null : d;
  }

  // ìœ í‹¸: ì£¼ë‹¨ìœ„(ì›”ìš”ì¼ ì‹œì‘)
  function startOfWeekMon(d) {
    // dëŠ” Date; ì›”ìš”ì¼(1) ì‹œì‘
    const day = d.getDay(); // 0=ì¼,1=ì›”,..
    const diff = (day === 0 ? -6 : 1 - day); // ì¼ìš”ì¼ì´ë©´ -6, ì›”ìš”ì¼ì´ë©´ 0, í™”ìš”ì¼ì´ë©´ -1 ...
    const s = new Date(d);
    s.setHours(0,0,0,0);
    s.setDate(s.getDate() + diff);
    return new Date(s.getFullYear(), s.getMonth(), s.getDate());
  }
  function addDays(date, days) {
    const d = new Date(date);
    d.setDate(d.getDate() + days);
    return d;
  }
  function weekKeyLabel(dMon) {
    // dMon: ì£¼ì˜ ì›”ìš”ì¼
    const y = dMon.getFullYear();
    const m = (dMon.getMonth()+1).toString().padStart(2,'0');
    const dd = dMon.getDate().toString().padStart(2,'0');
    // í‘œì‹œëŠ” "YYYY-ww (MM/DD~MM/DD)" ëŒ€ì‹  ê°„ê²°í•˜ê²Œ:
    const sun = addDays(dMon, 6);
    const m2 = (sun.getMonth()+1).toString().padStart(2,'0');
    const dd2 = sun.getDate().toString().padStart(2,'0');
    return `${y}-${m}-${dd}~${m2}-${dd2}`; // ì˜ˆ: 2025-10-27~11-02
  }
  function weekRangeKeys(minDate, maxDate) {
    // minDate/maxDateëŠ” ì¼ ë‹¨ìœ„. ë²”ìœ„ë¥¼ í¬ê´„í•˜ëŠ” ì²« ì›”ìš”ì¼~ë§ˆì§€ë§‰ ì›”ìš”ì¼
    const firstMon = startOfWeekMon(minDate);
    const lastMon  = startOfWeekMon(maxDate);
    const keys = [];
    let cur = new Date(firstMon);
    while (cur <= lastMon) {
      keys.push(weekKeyLabel(cur));
      cur = addDays(cur, 7);
    }
    return keys;
  }

  async function loadUserConfig() {
    const { data, error } = await sb
      .from('usr')
      .select('b_name,name,s_table,t_table,i_table,logo')
      .eq('uid', usrParam)
      .single();
    if (error || !data) { alert('ì‚¬ìš©ì ì„¤ì • ë¡œë“œ ì‹¤íŒ¨'); throw error || new Error('No user'); }
    config = data;
    document.getElementById('pageTitle').textContent = `ğŸ“ˆ ${config.b_name} ì‹¤ì  ì¶”ì´`;
    document.title = `${config.b_name} | ì‹¤ì  ì¶”ì´`;
  }

  async function loadItems() {
    const { data, error } = await sb
      .from(config.s_table)
      .select('done, date_e');
    if (error) { alert('ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨'); throw error; }
    itemsGlobal = (data || []).filter(r => r && r.done && r.date_e);
  }

  // ì§‘ê³„: ì›”/ì£¼
  function buildMonthlyCounts() {
    if (itemsGlobal.length === 0) return { labels: [], counts: [], info: 'ì™„ë£Œ ë°ì´í„° ì—†ìŒ' };

    const dates = itemsGlobal
      .map(r => parseDateSafe(r.date_e))
      .filter(Boolean)
      .map(d => new Date(d.getFullYear(), d.getMonth(), 1));
    if (dates.length === 0) return { labels: [], counts: [], info: 'ìœ íš¨í•œ ì¢…ë£Œì¼ ì—†ìŒ' };

    const minDate = new Date(Math.min(...dates));
    const now = new Date();
    const maxDate = new Date(now.getFullYear(), now.getMonth(), 1);

    const keys = monthRangeKeys(minDate, maxDate);
    const countMap = Object.fromEntries(keys.map(k => [k, 0]));
    for (const r of itemsGlobal) {
      const d = parseDateSafe(r.date_e);
      if (!d) continue;
      const key = ymKey(new Date(d.getFullYear(), d.getMonth(), 1));
      if (key in countMap) countMap[key] += 1;
    }
    const labels = keys;
    const counts = keys.map(k => countMap[k]);
    const info = `ê¸°ê°„: ${labels[0]} ~ ${labels[labels.length-1]} (ì´ ${labels.length}ê°œì›”)`;
    return { labels, counts, info };
  }

  function buildWeeklyCounts() {
    if (itemsGlobal.length === 0) return { labels: [], counts: [], info: 'ì™„ë£Œ ë°ì´í„° ì—†ìŒ' };

    const rawDates = itemsGlobal.map(r => parseDateSafe(r.date_e)).filter(Boolean);
    if (rawDates.length === 0) return { labels: [], counts: [], info: 'ìœ íš¨í•œ ì¢…ë£Œì¼ ì—†ìŒ' };

    const minDate = new Date(Math.min(...rawDates));
    const now = new Date();
    const maxDate = now; // í˜„ì¬ ì¼ìê¹Œì§€

    const keys = weekRangeKeys(minDate, maxDate);
    const countMap = Object.fromEntries(keys.map(k => [k, 0]));

    for (const r of itemsGlobal) {
      const d = parseDateSafe(r.date_e);
      if (!d) continue;
      const mon = startOfWeekMon(d);
      const key = weekKeyLabel(mon);
      if (key in countMap) countMap[key] += 1;
    }
    const labels = keys;
    const counts = keys.map(k => countMap[k]);

    // ë²”ìœ„ ì •ë³´: ì²« í‚¤/ë í‚¤ë¥¼ ê·¸ëŒ€ë¡œ í‘œê¸°
    const info = `ê¸°ê°„: ${labels[0]} ~ ${labels[labels.length-1]} (ì´ ${labels.length}ì£¼)`;
    return { labels, counts, info };
  }

  function renderTable(labels, counts, mode) {
    const tbody = document.querySelector('#tblCounts tbody');
    tbody.innerHTML = '';
    for (let i = 0; i < labels.length; i++) {
      tbody.insertAdjacentHTML('beforeend', `
        <tr><td>${labels[i]}</td><td>${counts[i]}</td></tr>
      `);
    }
    // í—¤ë”/íƒ€ì´í‹€ ì „í™˜
    document.getElementById('tableTitle').textContent =
      mode === 'week' ? 'ğŸ“‹ ì£¼ê°„ ê±´ìˆ˜ í‘œ' : 'ğŸ“‹ ì›”ë³„ ê±´ìˆ˜ í‘œ';
    document.getElementById('thLabel').textContent =
      mode === 'week' ? 'ì£¼(ì›”~ì¼ ë²”ìœ„)' : 'ì›”(YYYY-MM)';
  }

  function renderChart(labels, counts) {
    const canvas = document.getElementById('trendChart');
    const ctx = canvas.getContext('2d');

    if (chart) { chart.destroy(); chart = null; }

    const showLine = document.getElementById('lineToggle').checked;
    const datasets = [
      { type: 'bar', label: 'ì™„ë£Œ ê±´ìˆ˜', data: counts, borderWidth: 1 }
    ];
    if (showLine) {
      datasets.push({ type: 'line', label: 'ì¶”ì„¸ì„ ', data: counts, tension: 0.25, pointRadius: 2 });
    }

    chart = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets },
      options: {
        responsive: true,
        resizeDelay: 150,
        maintainAspectRatio: false,
        animation: false,
        plugins: {
          legend: { display: true },
          tooltip: {
            callbacks: {
              title: (items) => items?.[0]?.label ?? '',
              label: (item) => `${item.dataset.label}: ${item.parsed.y}ê±´`
            }
          }
        },
        scales: {
          x: { title: { display: true, text: 'êµ¬ê°„' } },
          y: { beginAtZero: true, title: { display: true, text: 'ê±´ìˆ˜' }, ticks: { precision: 0 } }
        }
      }
    });
  }

  function refresh(mode) {
    // mode: 'month' | 'week'
    let result = mode === 'week' ? buildWeeklyCounts() : buildMonthlyCounts();
    labelsGlobal = result.labels;
    countsGlobal = result.counts;

    // Quick stats
    const total = countsGlobal.reduce((a,b)=>a+b,0);
    const activeBins = countsGlobal.filter(c=>c>0).length;
    const avg = labelsGlobal.length ? Math.round(total / labelsGlobal.length) : 0;

    document.getElementById('rangeInfo').textContent = result.info;
    document.getElementById('quickStats').innerHTML = `
      <div>ì´ ì™„ë£Œê±´ìˆ˜: <b>${total}</b>ê±´</div>
      <div>í™œì„± êµ¬ê°„(>0): <b>${activeBins}</b></div>
      <div>êµ¬ê°„ í‰ê· : <b>${avg}</b>ê±´</div>
    `;

    renderTable(labelsGlobal, countsGlobal, mode);
    renderChart(labelsGlobal, countsGlobal);
  }

  // ì´ˆê¸° êµ¬ë™
  document.addEventListener('DOMContentLoaded', async () => {
    if (initDone) return;
    initDone = true;

    await loadUserConfig();
    await loadItems();

    // ë‚´ë¹„ê²Œì´ì…˜
    document.getElementById('btnMap').onclick    = () => location.href = `map.html?usr=${usrParam}`;
    document.getElementById('btnCal').onclick    = () => location.href = `cal.html?usr=${usrParam}`;
    document.getElementById('btnReport').onclick = () => location.href = `done.html?usr=${usrParam}`;

    // ìµœì´ˆ ì§„ì…: ì›” ë‹¨ìœ„ + ì„ í˜• ì²´í¬(ê¸°ë³¸ checked ì†ì„±ìœ¼ë¡œ ë°˜ì˜)
    refresh('month');

    // ì´ë²¤íŠ¸
    document.getElementById('lineToggle').addEventListener('change', () => {
      // ì°¨íŠ¸ë§Œ ë‹¤ì‹œ ê·¸ë¦¼ (ë°ì´í„°/í…Œì´ë¸”ì€ ê·¸ëŒ€ë¡œ)
      renderChart(labelsGlobal, countsGlobal);
    });
    document.getElementById('granularity').addEventListener('change', (e) => {
      const mode = e.target.value; // 'month' | 'week'
      refresh(mode);
    });
  });
</script>
</body>
</html>
