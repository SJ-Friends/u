<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>📈 실적 추이 (월/주)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f4f4;
      max-width: 1000px;
      margin: auto;
      padding: 40px 20px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 16px;
      gap: 10px;
    }
    h1 { margin: 0; color: #333; }
    .controls { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    select, button { padding: 8px 12px; font-size: 14px; border-radius: 6px; }
    button { background: #1d72b8; color: #fff; border: 0; cursor: pointer; }
    button:hover { background: #135a96; }
    .card {
      background: #fff; padding: 20px; border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px;
    }
    .stat {
      display: flex; gap: 12px; flex-wrap: wrap; margin-top: 10px;
    }
    .stat div {
      background: #eef; padding: 12px 14px; border-radius: 8px; font-size: 14px;
    }
    .muted { color: #666; font-size: 13px; margin-top: 6px; }
    table { width: 100%; border-collapse: collapse; margin-top: 14px; }
    th, td { padding: 10px; text-align: center; border-bottom: 1px solid #eee; }
    th { background: #f0f0f0; font-weight: 600; }
    /* 차트 안전 래퍼 (무한 높이 루프 방지) */
    .chart-wrap {
      position: relative;
      height: 360px;      /* 필요 시 300~480px 조절 */
      max-height: 60vh;
      overflow: hidden;
    }
    .chart-wrap canvas {
      position: absolute; inset: 0;
      width: 100% !important; height: 100% !important; display: block;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <h1 id="pageTitle">📈 실적 추이</h1>
    <div class="controls">
      <!-- ① 요청: 초기 체크 상태 -->
      <label style="user-select:none; cursor:pointer;">
        <input type="checkbox" id="lineToggle" checked /> 선형 추세선 표시
      </label>
      <!-- ② 요청: 월/주 단위 전환 -->
      <label for="granularity">보기:</label>
      <select id="granularity">
        <option value="month" selected>월 단위</option>
        <option value="week">주 단위</option>
      </select>
      <button id="btnReport">📋 리포트</button>
      <button id="btnMap">🗺️ 지도</button>
      <button id="btnCal">📅 캘린더</button>
    </div>
  </div>

  <div class="card">
    <div class="chart-wrap">
      <canvas id="trendChart"></canvas>
    </div>
    <div class="stat" id="quickStats"></div>
    <div class="muted" id="rangeInfo"></div>
  </div>

  <div class="card">
    <h2 id="tableTitle">📋 월별 건수 표</h2>
    <table id="tblCounts">
      <thead>
        <tr>
          <th id="thLabel">월(YYYY-MM)</th>
          <th>완료 건수</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
  // === Supabase 연결 ===
  const supabase = window.supabase.createClient(
    'https://xxmtxuhcdzidhrefrvwf.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4bXR4dWhjZHppZGhyZWZydndmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQwODAyNTQsImV4cCI6MjA1OTY1NjI1NH0.TaCCDlJvKrif_pZY038Qkglip8h-Qqjp2w2GlKwvoVg'
  );

  // usr 파라미터
  const urlParams = new URLSearchParams(window.location.search);
  const usrParam = urlParams.get('usr');
  if (!usrParam) { alert('usr 파라미터가 필요합니다.'); throw new Error('Missing usr'); }

  // 상태
  let config;
  let chart = null;
  let itemsGlobal = [];    // 원본 done + date_e 항목
  let labelsGlobal = [];   // 현재 라벨
  let countsGlobal = [];   // 현재 데이터
  let initDone = false;

  // 유틸: 월 라벨
  const ymKey = (d) => {
    const y = d.getFullYear();
    const m = (d.getMonth() + 1).toString().padStart(2, '0');
    return `${y}-${m}`;
  };
  const addMonths = (date, months) =>
    new Date(date.getFullYear(), date.getMonth() + months, 1);
  const monthRangeKeys = (minDate, maxDate) => {
    const keys = [];
    let cur = new Date(minDate);
    while (cur <= maxDate) {
      keys.push(ymKey(cur));
      cur = addMonths(cur, 1);
    }
    return keys;
  };
  function parseDateSafe(v) {
    if (!v) return null;
    const d = new Date(v);
    return isNaN(d.getTime()) ? null : d;
  }

  // 유틸: 주단위(월요일 시작)
  function startOfWeekMon(d) {
    // d는 Date; 월요일(1) 시작
    const day = d.getDay(); // 0=일,1=월,..
    const diff = (day === 0 ? -6 : 1 - day); // 일요일이면 -6, 월요일이면 0, 화요일이면 -1 ...
    const s = new Date(d);
    s.setHours(0,0,0,0);
    s.setDate(s.getDate() + diff);
    return new Date(s.getFullYear(), s.getMonth(), s.getDate());
  }
  function addDays(date, days) {
    const d = new Date(date);
    d.setDate(d.getDate() + days);
    return d;
  }
  function weekKeyLabel(dMon) {
    // dMon: 주의 월요일
    const y = dMon.getFullYear();
    const m = (dMon.getMonth()+1).toString().padStart(2,'0');
    const dd = dMon.getDate().toString().padStart(2,'0');
    // 표시는 "YYYY-ww (MM/DD~MM/DD)" 대신 간결하게:
    const sun = addDays(dMon, 6);
    const m2 = (sun.getMonth()+1).toString().padStart(2,'0');
    const dd2 = sun.getDate().toString().padStart(2,'0');
    return `${y}-${m}-${dd}~${m2}-${dd2}`; // 예: 2025-10-27~11-02
  }
  function weekRangeKeys(minDate, maxDate) {
    // minDate/maxDate는 일 단위. 범위를 포괄하는 첫 월요일~마지막 월요일
    const firstMon = startOfWeekMon(minDate);
    const lastMon  = startOfWeekMon(maxDate);
    const keys = [];
    let cur = new Date(firstMon);
    while (cur <= lastMon) {
      keys.push(weekKeyLabel(cur));
      cur = addDays(cur, 7);
    }
    return keys;
  }

  async function loadUserConfig() {
    const { data, error } = await supabase
      .from('usr')
      .select('b_name,name,s_table,t_table,i_table,logo')
      .eq('uid', usrParam)
      .single();
    if (error || !data) { alert('사용자 설정 로드 실패'); throw error || new Error('No user'); }
    config = data;
    document.getElementById('pageTitle').textContent = `📈 ${config.b_name} 실적 추이`;
    document.title = `${config.b_name} | 실적 추이`;
  }

  async function loadItems() {
    const { data, error } = await supabase
      .from(config.s_table)
      .select('done, date_e');
    if (error) { alert('데이터 불러오기 실패'); throw error; }
    itemsGlobal = (data || []).filter(r => r && r.done && r.date_e);
  }

  // 집계: 월/주
  function buildMonthlyCounts() {
    if (itemsGlobal.length === 0) return { labels: [], counts: [], info: '완료 데이터 없음' };

    const dates = itemsGlobal
      .map(r => parseDateSafe(r.date_e))
      .filter(Boolean)
      .map(d => new Date(d.getFullYear(), d.getMonth(), 1));
    if (dates.length === 0) return { labels: [], counts: [], info: '유효한 종료일 없음' };

    const minDate = new Date(Math.min(...dates));
    const now = new Date();
    const maxDate = new Date(now.getFullYear(), now.getMonth(), 1);

    const keys = monthRangeKeys(minDate, maxDate);
    const countMap = Object.fromEntries(keys.map(k => [k, 0]));
    for (const r of itemsGlobal) {
      const d = parseDateSafe(r.date_e);
      if (!d) continue;
      const key = ymKey(new Date(d.getFullYear(), d.getMonth(), 1));
      if (key in countMap) countMap[key] += 1;
    }
    const labels = keys;
    const counts = keys.map(k => countMap[k]);
    const info = `기간: ${labels[0]} ~ ${labels[labels.length-1]} (총 ${labels.length}개월)`;
    return { labels, counts, info };
  }

  function buildWeeklyCounts() {
    if (itemsGlobal.length === 0) return { labels: [], counts: [], info: '완료 데이터 없음' };

    const rawDates = itemsGlobal.map(r => parseDateSafe(r.date_e)).filter(Boolean);
    if (rawDates.length === 0) return { labels: [], counts: [], info: '유효한 종료일 없음' };

    const minDate = new Date(Math.min(...rawDates));
    const now = new Date();
    const maxDate = now; // 현재 일자까지

    const keys = weekRangeKeys(minDate, maxDate);
    const countMap = Object.fromEntries(keys.map(k => [k, 0]));

    for (const r of itemsGlobal) {
      const d = parseDateSafe(r.date_e);
      if (!d) continue;
      const mon = startOfWeekMon(d);
      const key = weekKeyLabel(mon);
      if (key in countMap) countMap[key] += 1;
    }
    const labels = keys;
    const counts = keys.map(k => countMap[k]);

    // 범위 정보: 첫 키/끝 키를 그대로 표기
    const info = `기간: ${labels[0]} ~ ${labels[labels.length-1]} (총 ${labels.length}주)`;
    return { labels, counts, info };
  }

  function renderTable(labels, counts, mode) {
    const tbody = document.querySelector('#tblCounts tbody');
    tbody.innerHTML = '';
    for (let i = 0; i < labels.length; i++) {
      tbody.insertAdjacentHTML('beforeend', `
        <tr><td>${labels[i]}</td><td>${counts[i]}</td></tr>
      `);
    }
    // 헤더/타이틀 전환
    document.getElementById('tableTitle').textContent =
      mode === 'week' ? '📋 주간 건수 표' : '📋 월별 건수 표';
    document.getElementById('thLabel').textContent =
      mode === 'week' ? '주(월~일 범위)' : '월(YYYY-MM)';
  }

  function renderChart(labels, counts) {
    const canvas = document.getElementById('trendChart');
    const ctx = canvas.getContext('2d');

    if (chart) { chart.destroy(); chart = null; }

    const showLine = document.getElementById('lineToggle').checked;
    const datasets = [
      { type: 'bar', label: '완료 건수', data: counts, borderWidth: 1 }
    ];
    if (showLine) {
      datasets.push({ type: 'line', label: '추세선', data: counts, tension: 0.25, pointRadius: 2 });
    }

    chart = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets },
      options: {
        responsive: true,
        resizeDelay: 150,
        maintainAspectRatio: false,
        animation: false,
        plugins: {
          legend: { display: true },
          tooltip: {
            callbacks: {
              title: (items) => items?.[0]?.label ?? '',
              label: (item) => `${item.dataset.label}: ${item.parsed.y}건`
            }
          }
        },
        scales: {
          x: { title: { display: true, text: '구간' } },
          y: { beginAtZero: true, title: { display: true, text: '건수' }, ticks: { precision: 0 } }
        }
      }
    });
  }

  function refresh(mode) {
    // mode: 'month' | 'week'
    let result = mode === 'week' ? buildWeeklyCounts() : buildMonthlyCounts();
    labelsGlobal = result.labels;
    countsGlobal = result.counts;

    // Quick stats
    const total = countsGlobal.reduce((a,b)=>a+b,0);
    const activeBins = countsGlobal.filter(c=>c>0).length;
    const avg = labelsGlobal.length ? Math.round(total / labelsGlobal.length) : 0;

    document.getElementById('rangeInfo').textContent = result.info;
    document.getElementById('quickStats').innerHTML = `
      <div>총 완료건수: <b>${total}</b>건</div>
      <div>활성 구간(>0): <b>${activeBins}</b></div>
      <div>구간 평균: <b>${avg}</b>건</div>
    `;

    renderTable(labelsGlobal, countsGlobal, mode);
    renderChart(labelsGlobal, countsGlobal);
  }

  // 초기 구동
  document.addEventListener('DOMContentLoaded', async () => {
    if (initDone) return;
    initDone = true;

    await loadUserConfig();
    await loadItems();

    // 내비게이션
    document.getElementById('btnMap').onclick    = () => location.href = `map.html?usr=${usrParam}`;
    document.getElementById('btnCal').onclick    = () => location.href = `cal.html?usr=${usrParam}`;
    document.getElementById('btnReport').onclick = () => location.href = `done.html?usr=${usrParam}`;

    // 최초 진입: 월 단위 + 선형 체크(기본 checked 속성으로 반영)
    refresh('month');

    // 이벤트
    document.getElementById('lineToggle').addEventListener('change', () => {
      // 차트만 다시 그림 (데이터/테이블은 그대로)
      renderChart(labelsGlobal, countsGlobal);
    });
    document.getElementById('granularity').addEventListener('change', (e) => {
      const mode = e.target.value; // 'month' | 'week'
      refresh(mode);
    });
  });
</script>
</body>
</html>
